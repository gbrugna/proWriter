<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProWriter</title>
    <link rel="stylesheet" href="style/login.css">
    <link rel="stylesheet" href="style/fixed_buttons.css">
    <link rel="stylesheet" href="style/common.css">
</head>

<body>
<div id="bg-image"></div>
<button id="go_home" onclick="location.href='/'"></button>
<div class="box" id="content">
    <div id="tabs">
        <button class="tab width50percent" type="submit" id="loginButton" onclick="showLoginForm()">Accedi
        </button>
        <button class="tab width50percent" type="submit" id="signupButton" onclick="showSignUpForm()">Registrati
        </button>
    </div>

    <div class="form invisible" id="loginForm">
        <form action="javascript:login()" method="post">
            <input type="text" id="email" class="generic-input" name="email" placeholder="Username"><br>
            <input type="password" id="password" class="generic-input" name="password" placeholder="Password"><br>
            <div id="errorLogin" class="invisible" ></div>
            <button type="submit" class="generic generic-light">Accedi</button>
        </form>
    </div>

    <div class="form invisible" id="signupForm">
        <form action="/api/v1/user" method="post">
            <input type="text" class="generic-input" name="email" placeholder="Email"><br>
            <input type="password" class="generic-input" name="password"
                   placeholder="Password (minimo 8 caratteri)"><br>
            <input type="text" class="generic-input" name="username" placeholder="Username"><br>
            <div id="errorSignup" class="invisible"></div>
            <button type="submit" class="generic generic-light">Crea Account</button>
        </form>
    </div>

</div>

<script>
    let loginForm = document.getElementById("loginForm");
    let signupForm = document.getElementById("signupForm");
    let loginBtn = document.getElementById("loginButton");
    let signupBtn = document.getElementById("signupButton");

    function showLoginForm() {
        loginForm.classList.remove('invisible');
        signupForm.classList.add('invisible');
        loginBtn.classList.add('tab_selected');
        signupBtn.classList.remove('tab_selected');
    }

    function showSignUpForm() {
        loginForm.classList.add('invisible');
        signupForm.classList.remove('invisible');
        loginBtn.classList.remove('tab_selected');
        signupBtn.classList.add('tab_selected');
    }

    async function login() {
        let email = document.getElementById('email').value;
        let password = document.getElementById('password').value;

        const response = await fetch('/api/v1/user/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, password: password})
        }).catch(error => console.error(error));

        const body = await response.json();
        if (body.state == "successful") {
            window.location.href = '/account';
        } else if (body.state == "wrong-psw") {
            displayError('login', 'wrong-psw');
        } else {
            displayError('login', 'email-not-found');
        }
    }

    function displayError(form, errorType){
        let errorBox = (form == 'login') ? document.getElementById('errorLogin') : document.getElementById('errorSignup');
        errorBox.classList.remove('invisible');
        if(form == 'login'){
            if (errorType == 'wrong-psw')
                errorBox.innerText = 'Password errata';
            else if(errorType == 'email-not-found')
                errorBox.innerText = 'Non esiste un account collegato a questo indirizzo mail.';
        }
        else if(form == 'signup'){
            return;
        }
    }

    showLoginForm();
</script>
</body>

</html>