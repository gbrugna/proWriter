<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProWriter</title>
    <link rel="stylesheet" href="style/fixed_buttons.css">
    <link rel="stylesheet" href="style/common.css">
    <link rel="stylesheet" href="style/login.css">
</head>

<body>
<div id="bg-image"></div>
<button id="go_home" onclick="location.href='/'"></button>
<div id="content-login" class="box">
    <div id="tabs">
        <button class="tab width50percent" type="submit" id="loginButton" onclick="showLoginForm()">Accedi
        </button>
        <button class="tab width50percent" type="submit" id="signupButton" onclick="showSignUpForm()">Registrati
        </button>
    </div>

    <div class="form invisible" id="loginForm">
        <form action="javascript:login()" method="post">
            <input type="text" id="loginEmail" class="generic-input" name="email" placeholder="Username"><br>
            <input type="password" id="loginPassword" class="generic-input" name="password" placeholder="Password"><br>
            <div id="errorLogin" class="invisible"></div>
            <button type="submit" class="generic generic-light">Accedi</button>
        </form>
    </div>

    <div class="form invisible" id="signupForm">
        <form action="javascript:signup()" method="post">
            <input type="text" id="signupEmail" class="generic-input" name="email" placeholder="Email"><br>
            <input type="password" class="generic-input" name="password"
                   placeholder="Password (minimo 8 caratteri)" id="signupPassword"><br>
            <input type="text" class="generic-input" id="username" name="username" placeholder="Username (minimo 4 caratteri)"><br>
            <div id="errorSignup" class="invisible"></div>
            <button type="submit" class="generic generic-light">Crea Account</button>
        </form>
    </div>

</div>

<script>
    let loginForm = document.getElementById("loginForm");
    let signupForm = document.getElementById("signupForm");
    let loginBtn = document.getElementById("loginButton");
    let signupBtn = document.getElementById("signupButton");

    function showLoginForm() {
        loginForm.classList.remove('invisible');
        signupForm.classList.add('invisible');
        loginBtn.classList.add('tab_selected');
        signupBtn.classList.remove('tab_selected');
    }

    function showSignUpForm() {
        loginForm.classList.add('invisible');
        signupForm.classList.remove('invisible');
        loginBtn.classList.remove('tab_selected');
        signupBtn.classList.add('tab_selected');
    }

    async function login() {
        let email = document.getElementById('loginEmail').value;
        let password = document.getElementById('loginPassword').value;

        const response = await fetch('/api/v1/user/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, password: password})
        }).catch(error => console.error(error));

        const body = await response.json();
        if (body.state == "successful") {
            window.location.href = '/account';
        } else if (body.state == "wrong-psw") {
            displayError('login', 'wrong-psw');
        } else {
            displayError('login', 'email-not-found');
        }
    }

    async function signup() {
        let email = document.getElementById('signupEmail').value.trimEnd();
        let password = document.getElementById('signupPassword');
        let username = document.getElementById('username').value.trimEnd();

        //checks that can be done client-side
        const regexExp = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/gi;
        if (!regexExp.test(email)) {
            displayError('signup', 'invalid-email');
            return;
        } else if (password.length < 8) {
            displayError('signup', 'short-pwd');
            return;
        } else if (username.length < 4) {
            displayError('signup', 'short-username');
            return;
        } else if (username.includes(" ")) {
            displayError('signup', 'spaces-in-username');
            return;
        }

        const response = await fetch('/api/v1/user/signup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, password: password, username: username})
        }).catch(error => console.error(error));


        const body = await response.json();
        //console.log(body.state);
        if (body.state == "successful") {
            //console.log("account-created!");
            window.location.href = '/account';
        } else if (body.state == "email-already-in-use") {
            //console.log("email-already-in-use");
            displayError('signup', 'email-already-in-use')
            /* } else if (body.state == "psw-too-short") {
                //console.log("psw-too-short"); Error managed on client-side
            } else if (body.state.localeCompare("invalid-email") == 0) {
                console.log("invalid-email"); */
        } else if (body.state.localeCompare("db-error") == 0) {
            displayError('signup', 'db-error');
            //console.log("db-error");
        }
    }

    function displayError(form, errorType) {
        let errorBox = (form == 'login') ? document.getElementById('errorLogin') : document.getElementById('errorSignup');
        errorBox.classList.remove('invisible');
        if (form == 'login') {
            if (errorType == 'wrong-psw')
                errorBox.innerText = 'Password errata';
            else if (errorType == 'email-not-found')
                errorBox.innerText = 'Non esiste un account collegato a questo indirizzo mail.';
        } else if (form == 'signup') {
            if (errorType == 'email-already-in-use')
                errorBox.innerText = 'Esiste già un account con questo indirizzo email';
            else if (errorType == 'db-error')
                errorBox.innerText = 'Si è verificato un errore per cui ti chiediamo di contattare gli amministratori del sistema.';
            else if (errorType == 'invalid-email')
                errorBox.innerText = 'Indirizzo email non valido';
            else if (errorType == 'short-pwd')
                errorBox.innerText = 'Inserire una password composta da almeno 8 caratteri';
            else if (errorType == 'short-username')
                errorBox.innerText = 'Inserire uno username coposto da almeno 4 caratteri';
            else if (errorType == 'spaces-in-username') 
                errorBox.innerText = 'Inserire uno username privo di spazi';
        }
    }

    showLoginForm();
</script>
</body>

</html>